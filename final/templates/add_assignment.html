{% extends 'base.html' %}
{% block content %}

{% if user.is_authenticated %}
  <div style="
    background-color: #e7f1ff;
    padding: 12px 25px;
    border-bottom: 1px solid #cfe2ff;
    text-align: right;
    font-weight: 600;
    color: #0d6efd;
  ">
    üëã Welcome, {{ user.get_full_name|default:user.username }}!
  </div>
{% endif %}

<style>
body {
    background: linear-gradient(135deg, #dbeafe, #eef2ff);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    padding: 15px;
}

/* Form container */
form {
    background-color: #ffffff;
    padding: 30px 35px;
    border-radius: 15px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.08);
    max-width: 550px;
    margin: 2rem auto;
    border-top: 5px solid #0d6efd;
    transition: transform 0.3s ease;
}
form:hover { transform: translateY(-2px); }

h1 {
    color: #0d6efd;
    text-align: center;
    font-weight: 700;
    margin-bottom: 1.5rem;
    font-size: 1.5rem;
}

form label {
    display: block;
    margin-bottom: 6px;
    font-weight: 600;
    color: #333;
}

form input,
form select {
    width: 100%;
    padding: 12px;
    margin-bottom: 18px;
    border-radius: 8px;
    border: 1.5px solid #d0d7de;
    font-size: 1rem;
    box-sizing: border-box;
    transition: all 0.3s ease;
}

form input:focus,
form select:focus {
    outline: none;
    border-color: #0d6efd;
    box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.15);
}

button {
    width: 100%;
    padding: 12px;
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1.05rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}
button:hover {
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
    box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
}

.list-btn {
    display: inline-block;
    margin-bottom: 20px;
    padding: 10px 18px;
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    transition: background 0.3s ease, transform 0.2s ease;
}
.list-btn:hover {
    background: linear-gradient(135deg, #2563eb, #1e40af);
    transform: translateY(-2px);
}

/* Flatpickr Disabled Dates */
.flatpickr-day.flatpickr-disabled {
    background: #e0e7ff !important;
    color: #94a3b8 !important;
    cursor: not-allowed;
    border-radius: 50%;
}

.invalid {
    border: 2px solid #ef4444 !important;
}

/* Responsive Styles */
@media (max-width: 768px) {
    form {
        padding: 25px 20px;
        margin: 1.5rem auto;
    }
    h1 { font-size: 1.3rem; }
    button { font-size: 0.95rem; padding: 10px; }
    .list-btn { width: 100%; font-size: 0.95rem; text-align: center; }
}

@media (max-width: 480px) {
    form { padding: 20px 15px; }
    h1 { font-size: 1.2rem; }
    button { font-size: 0.9rem; padding: 8px; }
    .list-btn { font-size: 0.9rem; padding: 8px; }
}
</style>

<!-- Flatpickr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<!-- Flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<form method="post" id="assignmentForm">
  <h1>üìç Add Location Assignment</h1>
  <div class="text-center">
    <a href="{% url 'assignment_list' %}" class="list-btn">üìã View Assignment List</a>
  </div>

  {% csrf_token %}
  {{ form.as_p }}

  <button type="submit">Add Assignment</button>
</form>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const takenDates = {{ taken_dates|safe }};
  const dateInput = document.querySelector("input[name='date']");

  function formatDate(dateObj) {
    return dateObj.toISOString().slice(0, 10);
  }

  flatpickr(dateInput, {
    dateFormat: "Y-m-d",
    minDate: "today",
    disable: takenDates,
    onDayCreate: function (dObj, dStr, fp, dayElem) {
      const thisDate = formatDate(dayElem.dateObj);
      if (takenDates.includes(thisDate)) {
        dayElem.classList.add("booked-date");
        dayElem.title = "Assigned date";
      }
    },
    onChange: function (selectedDates, dateStr, instance) {
      if (takenDates.includes(dateStr)) {
        alert(`‚ùå The date ${dateStr} is already assigned!`);
        dateInput.value = "";
        dateInput.classList.add("invalid");
        instance.clear();
      } else {
        dateInput.classList.remove("invalid");
      }
    }
  });

  dateInput.addEventListener("input", function () {
    if (takenDates.includes(this.value)) {
      alert(`‚ùå The date ${this.value} is already assigned!`);
      this.value = "";
      this.classList.add("invalid");
    } else {
      this.classList.remove("invalid");
    }
  });

  function capitalizeFirstLetter(str) {
    if (!str) return "";
    return str.charAt(0).toUpperCase() + str.slice(1);
  }

  const form = document.getElementById("assignmentForm");
  form.addEventListener("submit", function () {
    const nameInput = form.querySelector('input[name="name"]');
    const locationInput = form.querySelector('input[name="location"]');
    if (nameInput) nameInput.value = capitalizeFirstLetter(nameInput.value.trim());
    if (locationInput) locationInput.value = capitalizeFirstLetter(locationInput.value.trim());
  });
});
</script>

{% endblock %}