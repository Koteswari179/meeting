{% extends 'base.html' %}
{% block content %}
<style>
  body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #e0f2fe, #f0f9ff);
    color: #333;
    line-height: 1.6;
  }

  .container {
    max-width: 950px;
    margin: 40px auto;
    background: #ffffff;
    border-radius: 16px;
    padding: 40px;
    box-shadow: 0 8px 25px rgba(13, 110, 253, 0.15);
    border-top: 6px solid #0d6efd;
    transition: all 0.3s ease;
  }

  .container:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 30px rgba(13, 110, 253, 0.2);
  }

  h1 {
    text-align: center;
    color: #0d6efd;
    font-weight: 700;
    font-size: 28px;
    margin-bottom: 25px;
  }

  p.welcome {
    text-align: center;
    font-weight: 600;
    color: #2563eb;
    margin-bottom: 15px;
  }

  label {
    font-weight: 600;
    color: #374151;
  }

  input[type="date"],
  input[type="text"],
  input[type="time"],
  input[type="number"],
  textarea {
    width: 100%;
    padding: 10px 12px;
    border: 1.5px solid #d0d7de;
    border-radius: 8px;
    margin-top: 6px;
    margin-bottom: 18px;
    font-size: 15px;
    transition: all 0.3s ease;
  }

  input:focus,
  textarea:focus {
    outline: none;
    border-color: #0d6efd;
    box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.1);
  }

  button {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
    border: none;
    padding: 10px 18px;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25);
  }

  button:hover {
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
    box-shadow: 0 6px 18px rgba(37, 99, 235, 0.35);
    transform: translateY(-2px);
  }

  /* ‚úÖ Card for each location */
  .location-card {
    background: #f9fbff;
    border-left: 6px solid #0d6efd;
    border-radius: 12px;
    padding: 20px 25px;
    margin-bottom: 25px;
    box-shadow: 0 5px 15px rgba(13, 110, 253, 0.1);
    transition: all 0.3s ease;
  }

  .location-card:hover {
    background: #f1f6ff;
    box-shadow: 0 8px 20px rgba(13, 110, 253, 0.15);
  }

  .location-card h3 {
    color: #0d6efd;
    font-weight: 700;
    margin-bottom: 15px;
  }

  /* ‚úÖ Table for booked slots */
  .booked-table {
    width: 100%;
    border-collapse: collapse;
    margin: 15px 0 20px;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 3px 10px rgba(13, 110, 253, 0.1);
  }

  .booked-table th, .booked-table td {
    border: none;
    padding: 10px 12px;
    text-align: center;
  }

  .booked-table th {
    background: #0d6efd;
    color: white;
    font-weight: 600;
  }

  .booked-table tr.booked {
    background-color: #ffe6e6;
    color: #842029;
  }

  .no-booking {
    color: #16a34a;
    font-weight: 600;
    background-color: #dcfce7;
    padding: 8px 12px;
    border-radius: 6px;
    display: inline-block;
  }

  .links {
    text-align: center;
    margin-top: 30px;
  }

  .links a {
    color: #2563eb;
    text-decoration: none;
    margin: 0 10px;
    font-weight: 600;
  }

  .links a:hover {
    text-decoration: underline;
  }

  #results p {
    text-align: center;
    color: #6b7280;
  }
</style>

<div class="container">
  {% if user.is_authenticated %}
    <p class="welcome">üëã Welcome, {{ user.username }}!</p>
  {% endif %}
  

  <h1>üìÖ Check Location by Date</h1>

  <label>Select Date:</label>
  <input type="date" id="dateInput" />

  <div id="results"></div>
</div>

<script>
  const dateInput = document.getElementById("dateInput");
  const resultsEl = document.getElementById("results");

  // ‚úÖ Capitalize first letter utility
  function capitalizeFirstLetter(str) {
    if (!str) return "";
    return str.charAt(0).toUpperCase() + str.slice(1);
  }

  document.addEventListener("input", (e) => {
    if (e.target.name === "subject" || e.target.name === "agenda") {
      const val = e.target.value;
      if (val.length === 1) e.target.value = val.toUpperCase();
    }
  });

  // ‚úÖ Fetch available locations by date
  async function fetchLocation() {
    const date = dateInput.value;
    if (!date) {
      resultsEl.innerHTML = "";
      return;
    }

    try {
      const url = new URL("{% url 'get_location' %}", window.location.origin);
      url.searchParams.set("date", date);
      const resp = await fetch(url);
      const data = await resp.json();

      if (resp.ok && data.locations && data.locations.length > 0) {
        let html = "";

        data.locations.forEach((loc, idx) => {
          html += `
            <div class="location-card">
              <h3>${loc.name} ‚Äî ${loc.location}</h3>
          `;

          if (loc.booked_slots && loc.booked_slots.length > 0) {
            html += `
              <table class="booked-table">
                <tr><th>subject</th><th>Start</th><th>End</th></tr>
            `;
            loc.booked_slots.forEach(slot => {
              html += `
                <tr class="booked">
                  <td>${slot.subject || '-'}</td>
                  <td>${slot.event_time}</td>
                  <td>${slot.endtime}</td>
                </tr>
              `;
            });
            html += "</table>";
          } else {
            html += `<p class="no-booking">‚úÖ No bookings yet for this location.</p>`;
          }

          html += `
<form id="form-${idx}" onsubmit="return submitForm(event, ${idx})">
  <label>Date:</label>
  <input type="date" name="date" value="${date}" readonly>

  <label>Name:</label>
  <input type="text" name="name" value="${loc.name}" readonly>

  <label>Location:</label>
  <input type="text" name="location" value="${loc.location}" readonly>

  <label>Subject:</label>
  <input type="text" name="subject" required>

  <label>Agenda:</label>
  <textarea name="agenda" rows="3"></textarea>

  <label>Event_Time:</label>
  <input type="time" name="event_time" required>

  <label>Duration (hours):</label>
  <input type="number" name="duration" min="0.5" step="0.5" required>

  <!-- ‚úÖ New Fields -->
  <label>Referred By:</label>
  <input type="text" name="referred_by" placeholder="Enter who referred this event">

  <label>Place of Event:</label>
  <input type="text" name="place_of_event" placeholder="Enter the event venue">
  <label>Contact Number:</label>
  <input 
  type="tel"
  name="contact_number"
  maxlength="10"
  pattern="[0-9]{10}"
  inputmode="numeric"
  oninput="this.value = this.value.replace(/[^0-9]/g, '');"
  placeholder="Enter 10-digit mobile number"
  required
><br>


  <label>Invite Name:</label>
  <input type="text" name="invite_name" placeholder="Enter the name of invitee">
  

  <button type="submit">üíæ Save Meeting</button>
</form>
            </div>
          `;
        });

        resultsEl.innerHTML = html;
      } else {
        resultsEl.innerHTML = "<p>No locations found for this date.</p>";
      }
    } catch (error) {
      console.error("Error fetching locations:", error);
      resultsEl.innerHTML = "<p>Error loading locations.</p>";
    }
  }

  async function submitForm(event, idx) {
    event.preventDefault();
    const form = document.getElementById(`form-${idx}`);
    const subject = form.querySelector('input[name="subject"]');
    const desc = form.querySelector('textarea[name="agenda"]');
    if (subject) subject.value = capitalizeFirstLetter(subject.value.trim());
    if (desc) desc.value = capitalizeFirstLetter(desc.value.trim());

    const formData = new FormData(form);

    try {
      const resp = await fetch("{% url 'update_location' %}", {
        method: "POST",
        body: formData,
        headers: { "X-CSRFToken": getCookie("csrftoken") },
      });

      const result = await resp.json();
      if (resp.ok && result.status === "success") {
        alert(result.message || "‚úÖ Meeting saved successfully!");
        fetchLocation();
      } else {
        alert("‚ùå " + (result.message || "Failed to save meeting."));
      }
    } catch (error) {
      console.error("Submit error:", error);
      alert("‚ö†Ô∏è Error submitting form.");
    }
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.startsWith(name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  dateInput.addEventListener("change", fetchLocation);
</script>
{% endblock %}
